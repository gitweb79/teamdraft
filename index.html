<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3チームドラフトシステム</title>
    <style>
        /* --- 省略（元CSSそのまま／追加CSSは下部で追記） --- */
        /* 必要なら後でCSSを追記します */
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:"Segoe UI",Helvetica,Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:12px}
        .container{max-width:1240px;margin:auto;background:#fff;border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.15);overflow:hidden}
        .header{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:#fff;text-align:center;padding:28px 16px;position:relative}
        .header h1{font-size:1.9rem;margin-bottom:6px}
        .header p{font-size:.9rem;opacity:.9}
        .user-settings{position:absolute;right:16px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.2);border-radius:8px;padding:8px 12px;font-size:.75rem}
        .user-settings input{padding:6px 8px;font-size:.75rem;min-height:28px;width:100px;margin-right:6px}
        .user-settings button{padding:6px 12px;font-size:.75rem;min-height:28px}
        .user-settings p{margin-top:4px;font-size:.7rem}
        .connection-status{margin:16px;border:2px solid;border-radius:8px;padding:10px;text-align:center;font-weight:700;font-size:.85rem}
        .connection-status.connected{background:#d4edda;border-color:#28a745;color:#155724}
        .connection-status.disconnected{background:#f8d7da;border-color:#dc3545;color:#721c24}
        .connection-status.connecting{background:#fff3cd;border-color:#ffc107;color:#856404}
        .room-setup,.turn-indicator{margin:16px;border-radius:10px;padding:18px;text-align:center}
        .room-setup{background:#e3f2fd;border:2px solid #2196f3}
        .turn-indicator{background:#e3f2fd;border:2px solid #2196f3}
        .room-setup h3,.turn-indicator h3{color:#1976d2;font-size:1rem;margin-bottom:12px}
        .room-controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
        input[type=text]{flex:1 1 220px;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:1rem;min-height:44px}
        input[type=text]:focus{outline:none;border-color:#4facfe}
        button{padding:12px 20px;border:none;border-radius:8px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;font-weight:700;cursor:pointer;transition:.2s;min-height:44px;white-space:nowrap}
        button:hover{transform:translateY(-2px);box-shadow:0 6px 15px rgba(0,0,0,.2)}
        button:disabled{background:#ccc;cursor:not-allowed;transform:none;box-shadow:none}
        .online-users{display:none;margin:16px;background:#f0f8ff;border:2px solid #87ceeb;border-radius:10px;padding:16px}
        .online-users h4{color:#4682b4;margin-bottom:8px;font-size:.9rem}
        .user-list{display:flex;flex-wrap:wrap;gap:6px}
        .user-badge{background:#87ceeb;color:#fff;padding:4px 8px;border-radius:12px;font-size:.75rem}
        .content{padding:16px}
        .section{margin-bottom:26px}
        .section h2{font-size:1.1rem;color:#333;margin-bottom:12px;border-bottom:3px solid #4facfe;padding-bottom:6px}
        .member-registration{background:#f8f9fa;border:2px solid #e9ecef;border-radius:10px;padding:18px}
        .form-group{display:flex;gap:10px;flex-wrap:wrap}
        .game-controls{display:flex;flex-direction:column;gap:10px;text-align:center;margin:24px 0}
        .reset-btn{background:linear-gradient(135deg,#ff416c 0%,#ff4b2b 100%)}
        .game-area{display:grid;grid-template-columns:1fr;gap:20px;margin-top:20px}
        .available-members{order:2;background:#fff3cd;border:2px solid #ffeaa7;border-radius:10px;padding:14px}
        .available-members h3{color:#856404;font-size:1rem;margin-bottom:10px}
        .member-item{display:flex;justify-content:space-between;align-items:center;background:#fff;border:2px solid #ddd;border-radius:8px;padding:12px;margin:6px 0;cursor:pointer;transition:.2s;font-size:.9rem;min-height:46px;user-select:none}
        .member-item:hover{border-color:#4facfe;box-shadow:0 3px 10px rgba(0,0,0,.1);transform:translateY(-1px)}
        .member-item.selectable{background:#d4edda;border-color:#28a745}
        .member-item .remove-btn{background:#ff6161;color:#fff;border:none;border-radius:50%;width:26px;height:26px;font-size:1.2rem;display:flex;align-items:center;justify-content:center;cursor:pointer;margin-left:10px;}
        .empty-state{text-align:center;color:#666;font-style:italic;font-size:.8rem;padding:18px}
        .teams-container{order:1;display:grid;grid-template-columns:1fr;gap:16px}
        .team{min-height:200px;border:3px solid;border-radius:15px;padding:14px;transition:.25s}
        .team h3{text-align:center;background:#fff;border-radius:8px;padding:10px;font-size:1rem;box-shadow:0 2px 6px rgba(0,0,0,.1);margin-bottom:12px}
        .team-member{background:#fff;border-left:4px solid;padding:10px;border-radius:8px;margin:4px 0;font-size:.85rem;box-shadow:0 2px 6px rgba(0,0,0,.08);user-select:none}
        .team-a{border-color:#ff6b6b;background:linear-gradient(135deg,#ff9a9e 0%,#fecfef 100%)}
        .team-a .team-member{border-left-color:#ff6b6b}
        .team-b{border-color:#4ecdc4;background:linear-gradient(135deg,#a8edea 0%,#fed6e3 100%)}
        .team-b .team-member{border-left-color:#4ecdc4}
        .team-c{border-color:#45b7d1;background:linear-gradient(135deg,#96deda 0%,#50c9c3 100%)}
        .team-c .team-member{border-left-color:#45b7d1}
        .team.active{transform:scale(1.03);box-shadow:0 8px 22px rgba(0,0,0,.15)}
        @media(min-width:768px){
            .game-area{grid-template-columns:1fr 2fr}
            .teams-container{grid-template-columns:repeat(3,1fr);gap:20px}
            .game-controls{flex-direction:row;justify-content:center}
        }
        @media(max-width:480px){
            input[type=text],button{flex:1 1 100%}
            .user-settings{position:static;transform:none;margin-top:10px;background:rgba(255,255,255,0.3);width:100%}
        }
        /* DnDのドロップターゲット */
        .droppable-hover { outline: 3px solid #333; background: #e0f7fa !important; }
        .dragging { opacity: 0.5; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>🏆 3チームドラフトシステム</h1>
            <p>複数端末からリアルタイムにメンバーをドラフト</p>
            <div class="user-settings">
                <input id="userNameInput" type="text" placeholder="名前" maxlength="10" />
                <button onclick="updateUserName()">変更</button>
                <p>👤 <strong id="currentUserName">未設定</strong></p>
            </div>
        </header>
        <div id="connectionStatus" class="connection-status disconnected">🔴 Firebase 未接続</div>
        <section class="room-setup">
            <h3>ルームを作成 / 参加</h3>
            <div class="room-controls">
                <input id="roomInput" type="text" placeholder="ルーム名を入力" maxlength="20" />
                <button onclick="joinRoom()">参加</button>
                <button onclick="createRandomRoom()">ランダム作成</button>
                <button id="leaveRoomBtn" onclick="leaveRoom()" style="display:none;background:linear-gradient(135deg,#ff416c 0%,#ff4b2b 100%)">退室</button>
            </div>
            <p style="margin-top:10px;font-size:.75rem;color:#555">同じルーム名で入ると画面が同期されます</p>
        </section>
        <section id="activeRooms" class="room-setup" style="background:#f0f8ff;border-color:#87ceeb;margin-top:10px">
            <h3 style="color:#4682b4">アクティブなルーム</h3>
            <div id="roomList" style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:10px">
                <div class="empty-state">ルームを確認中...</div>
            </div>
        </section>
        <div id="onlineUsers" class="online-users">
            <h4>オンライン参加者 (<span id="userCount">0</span> 人)</h4>
            <div id="userList" class="user-list"></div>
        </div>
        <main class="content">
            <section class="section">
                <h2>メンバー登録</h2>
                <div class="member-registration">
                    <div class="form-group">
                        <input id="memberName" type="text" placeholder="メンバー名" maxlength="20" disabled />
                        <button id="addMemberBtn" onclick="addMember()" disabled>追加</button>
                    </div>
                    <p style="font-size:.75rem;color:#666">※ 最初に登録する3名が各チームの代表者になります</p>
                </div>
            </section>
            <div class="game-controls">
                <button id="startGameBtn" onclick="startGame()" disabled>ルームに参加してください</button>
                <button class="reset-btn" onclick="resetGame()" disabled>完全リセット</button>
            </div>
            <div id="turnIndicator" class="turn-indicator" style="display:none"><h3 id="turnText">ルームに参加してください</h3></div>
            <section class="game-area">
                <div class="available-members" id="availableMembersDropzone">
                    <h3>控えメンバー</h3>
                    <div id="availableMembers"><div class="empty-state">ルームに参加してください</div></div>
                </div>
                <div class="teams-container">
                    <div id="teamA" class="team team-a"><h3>🔴 チームA</h3><div id="teamAMembers" class="team–list"></div></div>
                    <div id="teamB" class="team team-b"><h3>🟢 チームB</h3><div id="teamBMembers" class="team–list"></div></div>
                    <div id="teamC" class="team team-c"><h3>🔵 チームC</h3><div id="teamCMembers" class="team–list"></div></div>
                </div>
            </section>
        </main>
    </div>
    <!-- Firebase -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
    <script>
        // ====== 既存ロジック省略: すべて元ファイル通り ======

        // ... Firebase, ルーム管理, メンバー登録, 状態同期、UI反映、ほぼ元ソースそのまま ...

        // ========== DnD用ユーティリティ ==============
        let dragMemberName = null, dragFrom = null;
        function dndStart(e, memberName, fromType) {
            dragMemberName = memberName;
            dragFrom = fromType;
            if(e.dataTransfer) e.dataTransfer.effectAllowed = "move";
            setTimeout(()=> {
                e.target.classList.add("dragging");
            }, 0);
        }
        function dndEnd(e) {
            dragMemberName = null; dragFrom = null;
            document.querySelectorAll('.droppable-hover').forEach(el=>el.classList.remove('droppable-hover'));
            document.querySelectorAll('.dragging').forEach(el=>el.classList.remove('dragging'));
        }
        function dndOver(e) {
            e.preventDefault(); if(e.dataTransfer) e.dataTransfer.dropEffect = "move";
            e.currentTarget.classList.add("droppable-hover");
        }
        function dndLeave(e) { e.currentTarget.classList.remove("droppable-hover"); }
        function dndDrop(e, toType) {
            e.preventDefault();
            document.querySelectorAll('.droppable-hover').forEach(el=>el.classList.remove('droppable-hover'));
            moveMemberBetweenLists(dragMemberName, dragFrom, toType);
        }
        // タッチ長押し対応
        function touchDnDInit(node, memberName, fromType) {
            let pressTimer = null;
            node.addEventListener('touchstart', e=>{
                pressTimer = setTimeout(()=>{
                    node.classList.add("dragging");
                    window.__dragTouch = { memberName, fromType, node };
                }, 300);
            });
            node.addEventListener('touchend', e=>{
                clearTimeout(pressTimer);
                setTimeout(()=>node.classList.remove("dragging"), 150);
                window.__dragTouch = null;
            });
        }

        // ========== メンバー移動と削除 =============
        function moveMemberBetweenLists(memberName, fromType, toType) {
            if(fromType === toType) return;
            if(!gameState) return;
            // 1. チーム→控え: teamsXから外し、available=true
            if(fromType.startsWith('team')) {
                let team = fromType.slice(4);
                let idx = gameState.teams[team].indexOf(memberName);
                if(idx !== -1) gameState.teams[team].splice(idx,1);
                let m = gameState.members.find(m=>m.name===memberName);
                if(m) m.available = true;
            }
            // 2. 控え→チーム: available→false, teamsX.push
            if(toType.startsWith('team')) {
                let team = toType.slice(4);
                if(!gameState.teams[team]) gameState.teams[team]=[];
                if(gameState.teams[team].includes(memberName)) return;
                gameState.teams[team].push(memberName);
                let m = gameState.members.find(m=>m.name===memberName);
                if(m) m.available = false;
            }
            // 3. 控え→控え or チーム→チーム（別チーム間）も対応
            if(fromType.startsWith('team') && toType.startsWith('team')) {
                // already done above
            }
            if(fromType==='available' && toType==='available') return;
            if(fromType==='available' && toType.startsWith('team')) {/*already done*/}
            if(fromType.startsWith('team') && toType==='available') {/*already done*/}
            syncGameState();
        }
        function removeAvailableMember(memberName) {
            if(!confirm(`${memberName} を控えから削除しますか？`)) return;
            let idx = gameState.members.findIndex(m=>m.name===memberName);
            if(idx!==-1) gameState.members.splice(idx,1);
            // もしチームにいた場合も除去
            ['A','B','C'].forEach(t=>{
                let i = gameState.teams[t].indexOf(memberName);
                if(i!==-1) gameState.teams[t].splice(i,1);
            });
            syncGameState();
        }

        // ====== 表示更新（DnD/削除組み込み） ======
        function updateAvailableMembers() {
            const container = document.getElementById('availableMembers');
            if(!currentRoom){
                container.innerHTML='<div class="empty-state">ルームに参加してください</div>'; return;
            }
            const available = gameState.members ? gameState.members.filter(m=>m.available) : [];
            if(!available.length){
                container.innerHTML='<div class="empty-state">控えメンバーがいません</div>'; return;
            }
            container.innerHTML = available.map(m=>`
                <div class="member-item"
                     draggable="true"
                     ondragstart="dndStart(event, '${m.name}','available')"
                     ondragend="dndEnd(event)"
                     ontouchstart=""
                     >${m.name}
                    <button class="remove-btn" onclick="removeAvailableMember('${m.name}');event.stopPropagation();">&times;</button>
                </div>
            `).join('');
            // タッチDnD初期化
            Array.from(container.children).forEach((el,i)=>{
                let m = available[i];
                touchDnDInit(el, m.name, 'available');
            });
        }
        function updateTeamDisplay() {
            ['A','B','C'].forEach(t=>{
                const listEl = document.getElementById(`team${t}Members`);
                const members = gameState.teams && gameState.teams[t] ? gameState.teams[t] : [];
                if(!members.length){
                    listEl.innerHTML='<div class="empty-state">メンバーなし</div>'; return;
                }
                listEl.innerHTML = members.map((name,i)=>`
                    <div class="team-member"
                        draggable="true"
                        ondragstart="dndStart(event, '${name}','team${t}')"
                        ondragend="dndEnd(event)"
                        ontouchstart=""
                    >${i===0?'👑 ':''}${name}${i===0?' (代表)':''}</div>
                `).join('');
                Array.from(listEl.children).forEach((el,j)=>{
                    touchDnDInit(el, members[j], 'team'+t);
                });
            });
        }
        // ドロップゾーンの初期化
        function initDropZones() {
            // 控え
            let av = document.getElementById('availableMembersDropzone');
            av.ondragover = dndOver;
            av.ondragleave = dndLeave;
            av.ondrop = e=>dndDrop(e,'available');
            av.ontouchmove = function(e) {
                if(window.__dragTouch) av.classList.add("droppable-hover");
            };
            av.ontouchend = function(e) {
                if(window.__dragTouch && av.classList.contains("droppable-hover")) {
                    moveMemberBetweenLists(window.__dragTouch.memberName, window.__dragTouch.fromType, 'available');
                }
                av.classList.remove("droppable-hover");
            };
            // チームA/B/C
            ['A','B','C'].forEach(t=>{
                let el = document.getElementById('team'+t);
                el.ondragover = dndOver;
                el.ondragleave = dndLeave;
                el.ondrop = e=>dndDrop(e, 'team'+t);
                el.ontouchmove = function(e) {
                    if(window.__dragTouch) el.classList.add("droppable-hover");
                };
                el.ontouchend = function(e) {
                    if(window.__dragTouch && el.classList.contains("droppable-hover")) {
                        moveMemberBetweenLists(window.__dragTouch.memberName, window.__dragTouch.fromType, 'team'+t);
                    }
                    el.classList.remove("droppable-hover");
                };
            });
        }
        // 完全リセット（全員を控えへ）
        function resetGame() {
            if(!confirm('本当に全員控えメンバーに戻しますか？')) return;
            // membersリストはそのまま、available=trueに
            if(gameState.members) gameState.members.forEach(m=>m.available=true);
            gameState.teams = {A:[],B:[],C:[]};
            gameState.gameStarted=false;
            gameState.isSelectingLeaders=true;
            gameState.leaderSelected={A:false,B:false,C:false};
            gameState.currentTeam='A';
            syncGameState();
        }

        // 既存の初期化window.load内で
        window.addEventListener('load',()=>{
            // ... (元の初期化処理) ...
            setTimeout(initDropZones,600); // 初回のみ
        });
        // gameState変化時にもdropzone再初期化
        function updateDisplay() {
            updateAvailableMembers();
            updateTeamDisplay();
            updateTurnIndicator();
            updateTeamHighlight();
            updateStartButton();
            setTimeout(initDropZones,150);
        }

        // チーム編成完了時のalert/自動再スタートは無効化
        function checkGameEnd() {
            if(gameState.members && gameState.members.every(m=>!m.available)){
                gameState.gameStarted=false;
                syncGameState();
                // alert('チーム編成が完了しました！'); // ←削除
            }
        }

        // --- その他既存ロジックはほぼそのまま ---
    </script>
</body>
</html>
